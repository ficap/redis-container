#!/bin/bash

export_vars=$(cgroup-limits); export $export_vars
source ${CONTAINER_SCRIPTS_PATH}/common.sh
set -eu

#pre-init phase
process_extending_files ${APP_DATA}/redis-pre-init/ ${CONTAINER_SCRIPTS_PATH}/pre-init/

# starting daemon locally without password so user's start hooks has access to db
${REDIS_PREFIX}/bin/redis-server /etc/redis.conf --requirepass known --bind "127.0.0.1" "$@" & 2>&1
wait_for_redis_up
# no other way how to start it without password
redis-cli -a known CONFIG SET requirepass ""

! process_extending_files ${APP_DATA}/redis-start/ ${CONTAINER_SCRIPTS_PATH}/start/ && redis-cli shutdown && false

redis-cli shutdown
wait_for_redis_down

# Restart the Redis server with public IP bindings
unset_env_vars
log_volume_info "${REDIS_DATADIR}"
log_info 'Running final exec -- Only Redis logs after this point'
exec ${REDIS_PREFIX}/bin/redis-server /etc/redis.conf --daemonize no "$@" 2>&1
